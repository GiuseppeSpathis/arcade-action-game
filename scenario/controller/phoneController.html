<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Game Controller</title>
    <link rel="stylesheet" href="phoneController.css">
</head>
<body>
    <div id="connectionPanel" class="panel">
        <h1>Arcade Controller</h1>
        <input type="text" id="roomCodeInput" placeholder="Enter Room Code (e.g. WXYZ)" maxlength="4" autocapitalize="characters">
        <select id="playerSelect">
            <option value="p2">Player 2</option>
            <option value="p3">Player 3</option>
            <option value="p4">Player 4</option>
        </select>
        <button id="connectButton">Connect</button>
        <p id="connectionStatus"></p>
    </div>

    <div id="controlsPanel" class="panel hidden">
        
        <div class="controls-dpad" id="dpad-move">
            <button id="moveUp" class="control-button dpad-button up" aria-label="Move Up">▲</button>
            <button id="moveLeft" class="control-button dpad-button left" aria-label="Move Left">◀</button>
            <button id="moveRight" class="control-button dpad-button right" aria-label="Move Right">▶</button>
            <button id="moveDown" class="control-button dpad-button down" aria-label="Move Down">▼</button>
        </div>
        
        <div class="controls-actions">
            <div class="controls-dpad" id="dpad-shoot">
                <button id="shootUp" class="control-button dpad-button up shoot-btn" aria-label="Shoot Up">▲</button>
                <button id="shootLeft" class="control-button dpad-button left shoot-btn" aria-label="Shoot Left">◀</button>
                <button id="shootRight" class="control-button dpad-button right shoot-btn" aria-label="Shoot Right">▶</button>
                <button id="shootDown" class="control-button dpad-button down shoot-btn" aria-label="Shoot Down">▼</button>
            </div>
            <button id="actionJump" class="control-button action-button jump" aria-label="Jump">JUMP</button>
        </div>

    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, updateDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { firebaseConfig } from "../../helper/firebaseConfig.js"; 

        let db;
        let docRef;
        let playerKey; 
        let sessionListenerUnsubscribe = null; 

        const connectionPanel = document.getElementById("connectionPanel");
        const controlsPanel = document.getElementById("controlsPanel");
        const connectButton = document.getElementById("connectButton");
        const roomCodeInput = document.getElementById("roomCodeInput");
        const playerSelect = document.getElementById("playerSelect");
        const connectionStatus = document.getElementById("connectionStatus");

        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                const auth = getAuth(app);
                await signInAnonymously(auth);
                console.log("Controller Firebase initialized and signed in.");
            } catch (error) {
                console.error("Firebase init failed:", error);
                connectionStatus.textContent = "Error: Could not connect to service.";
            }
        }

        function getDocPath(sessionId) {
            return `game_sessions/${sessionId}`;
        }

        function resetToLobby(message) {
            if (sessionListenerUnsubscribe) {
                sessionListenerUnsubscribe(); 
                sessionListenerUnsubscribe = null;
            }
            docRef = null;
            playerKey = null;

            controlsPanel.classList.add("hidden");
            connectionPanel.classList.remove("hidden");
            
            connectionStatus.textContent = message || "";
            roomCodeInput.value = ""; 
        }

        connectButton.addEventListener("click", async () => {
            const roomCode = roomCodeInput.value.trim().toUpperCase();
            if (roomCode.length !== 4) {
                connectionStatus.textContent = "Room Code must be 4 letters.";
                return;
            }
            if (!db) {
                connectionStatus.textContent = "Service not ready. Retrying...";
                await initFirebase();
                if (!db) {
                     connectionStatus.textContent = "Service failed. Please refresh.";
                     return;
                }
            }

            playerKey = playerSelect.value; 
            const path = getDocPath(roomCode);
            docRef = doc(db, path);

            try {
                connectionStatus.textContent = "Connecting...";
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists() || !docSnap.data().players || !docSnap.data().players[playerKey]) {
                    connectionStatus.textContent = "Error: Room not found or player slot invalid.";
                    return;
                }
                
                // NEW: Update with all 9 inputs
                await updateDoc(docRef, {
                    [`players.${playerKey}.inputs`]: { 
                        ml: false, mr: false, mu: false, md: false, // move
                        sl: false, sr: false, su: false, sd: false, // shoot
                        j: false // jump
                    },
                    [`players.${playerKey}.connected`]: true
                });
                
                connectionStatus.textContent = "Connected!";
                connectionPanel.classList.add("hidden");
                controlsPanel.classList.remove("hidden");
                
                if (sessionListenerUnsubscribe) {
                    sessionListenerUnsubscribe(); 
                }
                sessionListenerUnsubscribe = onSnapshot(docRef, (doc) => {
                    if (!doc.exists()) {
                        resetToLobby("Host disconnected.");
                        return;
                    }
                    const state = doc.data()?.gameState;
                    if (state === "gameover") {
                        resetToLobby("Game Over! Join a new game.");
                    } else if (state === "running") {
                        connectionStatus.textContent = "Game in progress...";
                    }
                });

                setupControls();

            } catch (error) {
                console.error("Error connecting to room:", error);
                connectionStatus.textContent = "Error: Connection failed.";
            }
        });

        function setupControls() {
            // NEW: Get all 9 buttons
            const buttons = [
                { el: document.getElementById("moveUp"), key: 'mu' },
                { el: document.getElementById("moveDown"), key: 'md' },
                { el: document.getElementById("moveLeft"), key: 'ml' },
                { el: document.getElementById("moveRight"), key: 'mr' },
                { el: document.getElementById("actionJump"), key: 'j' },
                { el: document.getElementById("shootUp"), key: 'su' },
                { el: document.getElementById("shootDown"), key: 'sd' },
                { el: document.getElementById("shootLeft"), key: 'sl' },
                { el: document.getElementById("shootRight"), key: 'sr' }
            ];

            const updateInput = (key, value) => {
                if (!docRef || !playerKey) return;
                const update = {};
                update[`players.${playerKey}.inputs.${key}`] = value; 
                updateDoc(docRef, update).catch(err => {
                    console.error("Failed to send input:", err);
                    resetToLobby("Disconnected from game.");
                });
            };

            // Add listeners for all 9 buttons
            buttons.forEach(({ el, key }) => {
                // Touch events
                el.addEventListener("touchstart", (e) => { e.preventDefault(); updateInput(key, true); }, { passive: false });
                el.addEventListener("touchend", (e) => { e.preventDefault(); updateInput(key, false); }, { passive: false });

                // Mouse events for testing
                el.addEventListener("mousedown", () => updateInput(key, true));
                el.addEventListener("mouseup", () => updateInput(key, false));
                el.addEventListener("mouseleave", () => updateInput(key, false));
            });
        }

        initFirebase();
    </script>
</body>
</html>