<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Game Controller</title>
    <link rel="stylesheet" href="controller.css">
</head>
<body>
    <div id="connectionPanel" class="panel">
        <h1>Arcade Controller</h1>
        <input type="text" id="roomCodeInput" placeholder="Enter Room Code (e.g. WXYZ)" maxlength="4" autocapitalize="characters">
        <select id="playerSelect">
            <option value="p2">Player 2</option>
            <option value="p3">Player 3</option>
            <option value="p4">Player 4</option>
        </select>
        <button id="connectButton">Connect</button>
        <p id="connectionStatus"></p>
    </div>

    <div id="controlsPanel" class="panel hidden">
        <div class="controls-dpad">
            <button id="dpadLeft" class="control-button dpad-button left" aria-label="Left"></button>
            <button id="dpadRight" class="control-button dpad-button right" aria-label="Right"></button>
        </div>
        <div class="controls-actions">
            <button id="actionShoot" class="control-button action-button shoot" aria-label="Shoot">B</button>
            <button id="actionJump" class="control-button action-button jump" aria-label="Jump">A</button>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, updateDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global vars from the parent environment
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let docRef;
        let playerKey; // e.g., "p2"

        const connectionPanel = document.getElementById("connectionPanel");
        const controlsPanel = document.getElementById("controlsPanel");
        const connectButton = document.getElementById("connectButton");
        const roomCodeInput = document.getElementById("roomCodeInput");
        const playerSelect = document.getElementById("playerSelect");
        const connectionStatus = document.getElementById("connectionStatus");

        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                const auth = getAuth(app);
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                console.log("Firebase initialized and signed in.");
            } catch (error) {
                console.error("Firebase init failed:", error);
                connectionStatus.textContent = "Error: Could not connect to service.";
            }
        }

        function getDocPath(sessionId) {
            return `artifacts/${appId}/public/data/game_sessions/${sessionId}`;
        }

        connectButton.addEventListener("click", async () => {
            const roomCode = roomCodeInput.value.trim().toUpperCase();
            if (roomCode.length !== 4) {
                connectionStatus.textContent = "Room Code must be 4 letters.";
                return;
            }
            if (!db) {
                connectionStatus.textContent = "Service not ready. Retrying...";
                await initFirebase();
                if (!db) {
                     connectionStatus.textContent = "Service failed. Please refresh.";
                     return;
                }
            }

            playerKey = playerSelect.value; // "p2", "p3", or "p4"
            const path = getDocPath(roomCode);
            docRef = doc(db, path);

            try {
                // Check if doc exists by trying to set (merge) data
                // This ensures the doc is created if the game is waiting
                await setDoc(docRef, { [playerKey]: { l: false, r: false, j: false, s: false } }, { merge: true });
                
                connectionStatus.textContent = "Connected!";
                connectionPanel.classList.add("hidden");
                controlsPanel.classList.remove("hidden");
                setupControls();

            } catch (error) {
                console.error("Error connecting to room:", error);
                connectionStatus.textContent = "Error: Room not found or connection failed.";
            }
        });

        function setupControls() {
            const dpadLeft = document.getElementById("dpadLeft");
            const dpadRight = document.getElementById("dpadRight");
            const actionJump = document.getElementById("actionJump");
            const actionShoot = document.getElementById("actionShoot");

            const updateInput = (key, value) => {
                if (!docRef || !playerKey) return;
                const update = {};
                update[`${playerKey}.${key}`] = value;
                updateDoc(docRef, update).catch(err => console.error("Failed to send input:", err));
            };

            // Touch events for mobile
            dpadLeft.addEventListener("touchstart", (e) => { e.preventDefault(); updateInput('l', true); }, { passive: false });
            dpadLeft.addEventListener("touchend", (e) => { e.preventDefault(); updateInput('l', false); }, { passive: false });
            
            dpadRight.addEventListener("touchstart", (e) => { e.preventDefault(); updateInput('r', true); }, { passive: false });
            dpadRight.addEventListener("touchend", (e) => { e.preventDefault(); updateInput('r', false); }, { passive: false });

            actionJump.addEventListener("touchstart", (e) => { e.preventDefault(); updateInput('j', true); }, { passive: false });
            actionJump.addEventListener("touchend", (e) => { e.preventDefault(); updateInput('j', false); }, { passive: false });

            actionShoot.addEventListener("touchstart", (e) => { e.preventDefault(); updateInput('s', true); }, { passive: false });
            actionShoot.addEventListener("touchend", (e) => { e.preventDefault(); updateInput('s', false); }, { passive: false });

            // Mouse events for testing on desktop
            dpadLeft.addEventListener("mousedown", () => updateInput('l', true));
            dpadLeft.addEventListener("mouseup", () => updateInput('l', false));
            dpadLeft.addEventListener("mouseleave", () => updateInput('l', false));

            dpadRight.addEventListener("mousedown", () => updateInput('r', true));
            dpadRight.addEventListener("mouseup", () => updateInput('r', false));
            dpadRight.addEventListener("mouseleave", () => updateInput('r', false));
            
            actionJump.addEventListener("mousedown", () => updateInput('j', true));
            actionJump.addEventListener("mouseup", () => updateInput('j', false));
            actionJump.addEventListener("mouseleave", () => updateInput('j', false));

            actionShoot.addEventListener("mousedown", () => updateInput('s', true));
            actionShoot.addEventListener("mouseup", () => updateInput('s', false));
            actionShoot.addEventListener("mouseleave", () => updateInput('s', false));
        }

        initFirebase();
    </script>
</body>
</html>